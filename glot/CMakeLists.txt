# With thanks to: http://bloerg.net/2012/11/10/cmake-and-distutils.html

# Originally, certain libraries were not available as Python3 (PythonOCC, in particular),
# so we need to have a Python2 component
find_program(PYTHON3 "python3")

# TODO: error out (sensibly & consistently) if no Py3: the user is not going to get much further
if (PYTHON3)
    # The CMake template for setup.py - effectively, this allows us to include CMake variables in
    # our setup.py, such as the target directory, source git revision, etc.
    set(SETUP_PY_IN "${CMAKE_CURRENT_SOURCE_DIR}/setup.py.in")
    set(SETUP_PY    "${CMAKE_CURRENT_BINARY_DIR}/setup.py")

    # This timestamp allows us to check whether a re-run is needed, based on the setup.py.in
    # modification time
    set(OUTPUT      "${CMAKE_CURRENT_BINARY_DIR}/build/timestamp")

    # Connect the input setup.py(.in) to the output
    configure_file(${SETUP_PY_IN} ${SETUP_PY})

    # Add the command that (triggers processing of and) runs setup.py [build]
    add_custom_command(OUTPUT ${OUTPUT}
                       COMMAND ${PYTHON3} ${SETUP_PY} build
                       COMMAND ${CMAKE_COMMAND} -E touch ${OUTPUT}
                       DEPENDS ${DEPS})

    # Add this new command as a target for ALL
    add_custom_target(target ALL DEPENDS ${OUTPUT} ${CMAKE_CURRENT_SOURCE_DIR}/conf/glot.yml)

    # On install, run setup.py [install]
    install(CODE "execute_process(COMMAND ${PYTHON3} ${SETUP_PY} install --prefix=${CMAKE_INSTALL_PREFIX})")
    file(GLOB CONFIG_FILES "${CMAKE_CURRENT_SOURCE_DIR}/conf/*")
    install(FILES ${CONFIG_FILES} DESTINATION ${ETC_LOCATION} COMPONENT config)
endif()
